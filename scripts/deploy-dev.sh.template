#!/bin/bash
# Deploy the message wall infrastructure to dev environment
# This script is idempotent and waits for resources to be ready
#
# Generated by setup wizard - do not edit directly
# Edit scripts/deploy-dev.sh.template instead
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "${SCRIPT_DIR}")"
CLUSTER_CONTEXT="kind-actuator"
INFRA_DIR="${PROJECT_ROOT}/infra/base"

# Configuration (baked in by setup wizard)
BUCKET_NAME="${BUCKET_NAME}"
REGION="${AWS_REGION}"
RESOURCE_PREFIX="${RESOURCE_PREFIX}"
ENVIRONMENT="${ENVIRONMENT}"

echo "=== Message Wall Dev Deployment ==="
echo ""

# Check if cluster is reachable
if ! kubectl cluster-info --context "${CLUSTER_CONTEXT}" &> /dev/null; then
    echo "Error: Cannot reach cluster '${CLUSTER_CONTEXT}'."
    echo "Make sure the kind cluster is running and Crossplane is installed."
    exit 1
fi

# Check if Crossplane providers are healthy
echo "Checking Crossplane providers..."
if ! kubectl get providers --context "${CLUSTER_CONTEXT}" | grep -q "True.*True"; then
    echo "Error: Crossplane AWS providers are not healthy."
    echo "Run bootstrap-aws-providers.sh first."
    exit 1
fi
echo "Crossplane providers are healthy."
echo ""

# Build and upload Lambda artifacts
echo "Building Lambda artifacts..."
"${PROJECT_ROOT}/app/api-handler/build.sh"
"${PROJECT_ROOT}/app/snapshot-writer/build.sh"

echo ""
echo "Uploading Lambda artifacts to S3..."
# Note: S3 bucket must exist first, so we apply infra in stages

# Stage 1: Core infrastructure (S3, DynamoDB, IAM)
echo ""
echo "Stage 1: Applying core infrastructure..."
kubectl apply -f "${INFRA_DIR}/s3.yaml" --context "${CLUSTER_CONTEXT}"
kubectl apply -f "${INFRA_DIR}/dynamodb.yaml" --context "${CLUSTER_CONTEXT}"
kubectl apply -f "${INFRA_DIR}/iam.yaml" --context "${CLUSTER_CONTEXT}"

echo "Waiting for S3 bucket to be ready..."
kubectl wait --for=condition=Ready bucket/${RESOURCE_PREFIX}-${ENVIRONMENT}-bucket --timeout=120s --context "${CLUSTER_CONTEXT}"

echo "Waiting for DynamoDB table to be ready..."
kubectl wait --for=condition=Ready table/${RESOURCE_PREFIX}-${ENVIRONMENT}-table --timeout=120s --context "${CLUSTER_CONTEXT}"

echo "Waiting for IAM roles to be ready..."
kubectl wait --for=condition=Ready role.iam/${RESOURCE_PREFIX}-api-role --timeout=120s --context "${CLUSTER_CONTEXT}"
kubectl wait --for=condition=Ready role.iam/${RESOURCE_PREFIX}-snapshot-role --timeout=120s --context "${CLUSTER_CONTEXT}"

# Upload Lambda artifacts now that bucket exists
echo ""
echo "Uploading Lambda artifacts..."
aws s3 cp "${PROJECT_ROOT}/app/api-handler/api-handler.zip" s3://${BUCKET_NAME}/artifacts/api-handler.zip
aws s3 cp "${PROJECT_ROOT}/app/snapshot-writer/snapshot-writer.zip" s3://${BUCKET_NAME}/artifacts/snapshot-writer.zip

# Stage 2: Lambda functions
echo ""
echo "Stage 2: Applying Lambda functions..."
kubectl apply -f "${INFRA_DIR}/lambda.yaml" --context "${CLUSTER_CONTEXT}"

echo "Waiting for Lambda functions to be ready..."
kubectl wait --for=condition=Ready function.lambda/${RESOURCE_PREFIX}-api-handler --timeout=120s --context "${CLUSTER_CONTEXT}"
kubectl wait --for=condition=Ready function.lambda/${RESOURCE_PREFIX}-snapshot-writer --timeout=120s --context "${CLUSTER_CONTEXT}"

# Stage 3: Function URL and EventBridge
echo ""
echo "Stage 3: Applying Function URL and EventBridge..."
kubectl apply -f "${INFRA_DIR}/function-url.yaml" --context "${CLUSTER_CONTEXT}"
kubectl apply -f "${INFRA_DIR}/eventbridge.yaml" --context "${CLUSTER_CONTEXT}"

echo "Waiting for Function URL to be ready..."
kubectl wait --for=condition=Ready functionurl/${RESOURCE_PREFIX}-api-handler-url --timeout=120s --context "${CLUSTER_CONTEXT}"

echo "Waiting for EventBridge rule to be ready..."
kubectl wait --for=condition=Ready rule.cloudwatchevents/${RESOURCE_PREFIX}-snapshot-trigger --timeout=120s --context "${CLUSTER_CONTEXT}"

# Upload static website
echo ""
echo "Uploading static website..."
aws s3 cp "${PROJECT_ROOT}/app/web/index.html" s3://${BUCKET_NAME}/index.html --content-type "text/html"

# Get endpoints
echo ""
echo "=== Deployment Complete ==="
echo ""
FUNCTION_URL=$(kubectl get functionurl ${RESOURCE_PREFIX}-api-handler-url -o jsonpath='{.status.atProvider.functionUrl}' --context "${CLUSTER_CONTEXT}")
echo "Website:      http://${BUCKET_NAME}.s3-website-${REGION}.amazonaws.com/"
echo "API:          ${FUNCTION_URL}"
echo ""
echo "IMPORTANT: Run './scripts/finalize-web.sh' to update index.html with the Function URL."
echo "Then run './scripts/smoke-test.sh' to verify the deployment."
