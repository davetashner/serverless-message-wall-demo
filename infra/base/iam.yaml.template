# IAM roles for Lambda functions
# See ADR-006 for IAM strategy and permission boundary requirements
#
# All roles must have MessageWallRoleBoundary permission boundary attached.
# This ensures Lambda functions can only access ${RESOURCE_PREFIX}-* resources.
---
# API Handler Lambda execution role
# Permissions: DynamoDB read/write, EventBridge PutEvents, CloudWatch Logs
apiVersion: iam.aws.upbound.io/v1beta1
kind: Role
metadata:
  name: ${RESOURCE_PREFIX}-api-role
  annotations:
    crossplane.io/external-name: ${RESOURCE_PREFIX}-api-role
spec:
  forProvider:
    assumeRolePolicy: |
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Principal": {
              "Service": "lambda.amazonaws.com"
            },
            "Action": "sts:AssumeRole"
          }
        ]
      }
    permissionsBoundary: arn:aws:iam::${AWS_ACCOUNT_ID}:policy/MessageWallRoleBoundary
  providerConfigRef:
    name: default
---
# Inline policy for API Handler role
apiVersion: iam.aws.upbound.io/v1beta1
kind: RolePolicy
metadata:
  name: ${RESOURCE_PREFIX}-api-role-policy
spec:
  forProvider:
    roleRef:
      name: ${RESOURCE_PREFIX}-api-role
    policy: |
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Sid": "DynamoDBAccess",
            "Effect": "Allow",
            "Action": [
              "dynamodb:GetItem",
              "dynamodb:PutItem",
              "dynamodb:UpdateItem",
              "dynamodb:Query"
            ],
            "Resource": "arn:aws:dynamodb:${AWS_REGION}:${AWS_ACCOUNT_ID}:table/${RESOURCE_PREFIX}-*"
          },
          {
            "Sid": "EventBridgeAccess",
            "Effect": "Allow",
            "Action": "events:PutEvents",
            "Resource": "*"
          },
          {
            "Sid": "CloudWatchLogsAccess",
            "Effect": "Allow",
            "Action": [
              "logs:CreateLogGroup",
              "logs:CreateLogStream",
              "logs:PutLogEvents"
            ],
            "Resource": "arn:aws:logs:${AWS_REGION}:${AWS_ACCOUNT_ID}:log-group:/aws/lambda/${RESOURCE_PREFIX}-*:*"
          }
        ]
      }
  providerConfigRef:
    name: default
---
# Snapshot Writer Lambda execution role
# Permissions: DynamoDB read, S3 PutObject, CloudWatch Logs
apiVersion: iam.aws.upbound.io/v1beta1
kind: Role
metadata:
  name: ${RESOURCE_PREFIX}-snapshot-role
  annotations:
    crossplane.io/external-name: ${RESOURCE_PREFIX}-snapshot-role
spec:
  forProvider:
    assumeRolePolicy: |
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Principal": {
              "Service": "lambda.amazonaws.com"
            },
            "Action": "sts:AssumeRole"
          }
        ]
      }
    permissionsBoundary: arn:aws:iam::${AWS_ACCOUNT_ID}:policy/MessageWallRoleBoundary
  providerConfigRef:
    name: default
---
# Inline policy for Snapshot Writer role
apiVersion: iam.aws.upbound.io/v1beta1
kind: RolePolicy
metadata:
  name: ${RESOURCE_PREFIX}-snapshot-role-policy
spec:
  forProvider:
    roleRef:
      name: ${RESOURCE_PREFIX}-snapshot-role
    policy: |
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Sid": "DynamoDBReadAccess",
            "Effect": "Allow",
            "Action": [
              "dynamodb:GetItem",
              "dynamodb:Query"
            ],
            "Resource": "arn:aws:dynamodb:${AWS_REGION}:${AWS_ACCOUNT_ID}:table/${RESOURCE_PREFIX}-*"
          },
          {
            "Sid": "S3WriteAccess",
            "Effect": "Allow",
            "Action": [
              "s3:PutObject"
            ],
            "Resource": "arn:aws:s3:::${RESOURCE_PREFIX}-*/state.json"
          },
          {
            "Sid": "CloudWatchLogsAccess",
            "Effect": "Allow",
            "Action": [
              "logs:CreateLogGroup",
              "logs:CreateLogStream",
              "logs:PutLogEvents"
            ],
            "Resource": "arn:aws:logs:${AWS_REGION}:${AWS_ACCOUNT_ID}:log-group:/aws/lambda/${RESOURCE_PREFIX}-*:*"
          }
        ]
      }
  providerConfigRef:
    name: default
