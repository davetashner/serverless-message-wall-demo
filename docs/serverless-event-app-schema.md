# ServerlessEventApp Schema Reference

This document describes the `ServerlessEventApp` Crossplane XRD (CompositeResourceDefinition) that provides a single abstraction for deploying the message wall serverless application.

## Overview

The `ServerlessEventApp` XRD composes 17 AWS managed resources into a single developer-facing API. Developers specify **intent** (environment, memory, timeout) without needing to understand AWS IAM policies, S3 configurations, or EventBridge wiring.

```
ServerlessEventAppClaim (developer authors this)
        │
        ▼
ServerlessEventApp (Crossplane Composite)
        │
        ▼
17 AWS Managed Resources (Crossplane manages these)
```

## API Reference

### Spec Fields

| Field | Type | Required | Default | Description |
|-------|------|----------|---------|-------------|
| `awsAccountId` | string | **Yes** | - | 12-digit AWS account ID. Used for ARNs and globally unique resource names. |
| `environment` | string | **Yes** | - | Deployment environment: `dev`, `staging`, or `prod`. |
| `resourcePrefix` | string | No | `messagewall` | Prefix for AWS resource names. Must be lowercase alphanumeric with hyphens. |
| `region` | string | No | `us-east-1` | AWS region. Allowed: `us-east-1`, `us-west-2`, `eu-west-1`. |
| `lambdaMemory` | integer | No | `128` | Lambda memory in MB. Range: 128-10240. |
| `lambdaTimeout` | integer | No | `10` | Lambda timeout in seconds. Range: 1-900. |
| `eventSource` | string | No | `messagewall.api-handler` | EventBridge event source identifier for matching events. |
| `artifactBucket` | string | No | `""` | S3 bucket for Lambda artifacts. If empty, uses the app bucket. |

### Status Fields

| Field | Type | Description |
|-------|------|-------------|
| `websiteEndpoint` | string | S3 static website URL for the frontend. |
| `apiEndpoint` | string | Lambda Function URL for the API handler (generated by AWS). |
| `bucketName` | string | Name of the provisioned S3 bucket. |
| `tableName` | string | Name of the provisioned DynamoDB table. |
| `ready` | boolean | `true` when all child resources are ready. |
| `message` | string | Human-readable status message. |

## Examples

### Minimal Dev Claim

```yaml
apiVersion: messagewall.demo/v1alpha1
kind: ServerlessEventAppClaim
metadata:
  name: messagewall-dev
  namespace: default
spec:
  environment: dev
  awsAccountId: "123456789012"
```

### Production Claim with Custom Settings

```yaml
apiVersion: messagewall.demo/v1alpha1
kind: ServerlessEventAppClaim
metadata:
  name: messagewall-prod
  namespace: default
spec:
  environment: prod
  awsAccountId: "123456789012"
  resourcePrefix: messagewall
  region: us-east-1
  lambdaMemory: 256      # Higher memory for production
  lambdaTimeout: 30      # Longer timeout for reliability
  eventSource: messagewall.api-handler
```

### Multi-Region Deployment

```yaml
apiVersion: messagewall.demo/v1alpha1
kind: ServerlessEventAppClaim
metadata:
  name: messagewall-eu
  namespace: default
spec:
  environment: prod
  awsAccountId: "123456789012"
  region: eu-west-1
  resourcePrefix: messagewall-eu
```

## Composed Resources

The Composition creates these AWS resources in dependency order:

**Stage 1 (no dependencies):**
- S3 Bucket
- DynamoDB Table
- IAM Role: api-handler
- IAM Role: snapshot-writer

**Stage 2 (depends on Stage 1):**
- S3 BucketOwnershipControls
- S3 BucketPublicAccessBlock
- S3 BucketWebsiteConfiguration
- S3 BucketPolicy
- S3 BucketCorsConfiguration
- IAM RolePolicy: api-handler
- IAM RolePolicy: snapshot-writer
- Lambda Function: api-handler
- Lambda Function: snapshot-writer

**Stage 3 (depends on Stage 2):**
- Lambda FunctionURL
- EventBridge Rule
- EventBridge Target
- Lambda Permission (for EventBridge)

## Troubleshooting

### Checking Claim Status

```bash
# Watch Claim status
kubectl get serverlesseventappclaim messagewall-dev -w

# Get detailed status
kubectl describe serverlesseventappclaim messagewall-dev

# List all managed resources for a Claim
kubectl get managed -l crossplane.io/claim-name=messagewall-dev
```

### Common Status Conditions

| Condition | Meaning | Resolution |
|-----------|---------|------------|
| `Ready=True` | All resources provisioned successfully | None needed |
| `Ready=False`, `Synced=True` | Resources are syncing but not yet ready | Wait for AWS to provision resources (can take 1-2 minutes) |
| `Synced=False` | Crossplane cannot reconcile | Check events: `kubectl describe <resource>` |

### Common Errors

#### "Permission boundary policy not found"

```
Error: arn:aws:iam::123456789012:policy/MessageWallRoleBoundary does not exist
```

**Cause**: The IAM permission boundary must exist before creating the Claim.

**Fix**: Create the permission boundary:
```bash
./scripts/create-iam-prerequisites.sh
```

#### "Lambda artifact not found"

```
Error: S3 key artifacts/api-handler.zip does not exist
```

**Cause**: Lambda ZIP files must be uploaded before the Functions can be created.

**Fix**: Build and upload artifacts:
```bash
./scripts/package-lambdas.sh
./scripts/upload-artifacts.sh
```

#### "Bucket name already exists"

```
Error: BucketAlreadyExists: The requested bucket name is not available
```

**Cause**: S3 bucket names are globally unique. Another account owns this name.

**Fix**: Change `resourcePrefix` to something unique:
```yaml
spec:
  resourcePrefix: mycompany-messagewall
```

#### "Function URL not appearing in status"

**Cause**: The Function URL is only generated after the Lambda reaches Ready state.

**Fix**: Wait for the Lambda to be ready:
```bash
kubectl get function -l crossplane.io/claim-name=messagewall-dev -w
```

### Viewing Resource Events

```bash
# Get events for a specific managed resource
kubectl describe bucket -l crossplane.io/claim-name=messagewall-dev

# Get all events in the namespace
kubectl get events --sort-by='.lastTimestamp'
```

### Deleting a Claim

Deleting a Claim removes all composed resources:

```bash
kubectl delete serverlesseventappclaim messagewall-dev
```

**Note**: S3 bucket deletion will fail if the bucket is not empty. Empty the bucket first:
```bash
aws s3 rm s3://messagewall-dev-123456789012 --recursive
```

## Related Documentation

- [XRD Definition](../platform/crossplane/xrd/serverless-event-app.yaml)
- [AWS Composition](../platform/crossplane/compositions/serverless-event-app-aws.yaml)
- [Example Claims](../examples/claims/)
- [Test Suite](../scripts/test-xrd.sh)
