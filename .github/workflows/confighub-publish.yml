name: Publish to ConfigHub

# Composition Render Pipeline (ADR-014)
#
# Renders Claims through the Crossplane Composition at build time,
# producing fully-expanded managed resources for ConfigHub.
# Crossplane in-cluster acts as a pure reconciler.
#
# Conflict detection per ADR-011: Git â†’ ConfigHub as proposal.

on:
  push:
    branches: [main]
    paths:
      - 'infra/claims/**'
      - 'platform/crossplane/compositions/**'
      - 'platform/crossplane/xrd/**'
      - 'platform/crossplane/functions/**'
      - 'scripts/render-composition.sh'
      - 'scripts/validate-policies.sh'
      - '.github/workflows/confighub-publish.yml'
  pull_request:
    branches: [main]
    paths:
      - 'infra/claims/**'
      - 'platform/crossplane/compositions/**'
      - 'platform/crossplane/xrd/**'
      - 'platform/crossplane/functions/**'
      - 'scripts/render-composition.sh'
      - 'scripts/validate-policies.sh'
      - '.github/workflows/confighub-publish.yml'
  workflow_dispatch:
    inputs:
      overlay:
        description: 'Overlay to publish'
        required: true
        default: 'dev-east'
        type: choice
        options:
          - dev-east
          - dev-west
          - prod-east
          - prod-west
          - all
      force:
        description: 'Force publish (skip conflict detection)'
        required: false
        default: false
        type: boolean

jobs:
  render-and-publish:
    runs-on: ubuntu-latest
    environment: dev

    strategy:
      matrix:
        # On PR: render dev-east only for fast feedback
        # On push to main or dispatch: render requested overlays
        overlay: ${{ github.event_name == 'pull_request' && fromJson('["dev-east"]') || github.event.inputs.overlay == 'all' && fromJson('["dev-east","dev-west","prod-east","prod-west"]') || fromJson(format('["{0}"]', github.event.inputs.overlay || 'dev-east')) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          # Install Crossplane CLI
          curl -sL "https://raw.githubusercontent.com/crossplane/crossplane/master/install.sh" | sh
          sudo mv crossplane /usr/local/bin/

          # Install yq
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

          # Install kustomize
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

          # Install cub CLI
          curl -fsSL https://hub.confighub.com/cub/install.sh | bash
          echo "$HOME/.confighub/bin" >> $GITHUB_PATH

      - name: Render composition
        id: render
        run: |
          OVERLAY="${{ matrix.overlay }}"
          OUTPUT_DIR="rendered/${OVERLAY}"

          echo "Rendering overlay: ${OVERLAY}"
          ./scripts/render-composition.sh --overlay "${OVERLAY}" --output-dir "${OUTPUT_DIR}"

          # Get ConfigHub space name
          SPACE=$(./scripts/render-composition.sh --get-space "${OVERLAY}")
          echo "space=${SPACE}" >> $GITHUB_OUTPUT
          echo "output_dir=${OUTPUT_DIR}" >> $GITHUB_OUTPUT

          # List rendered files for summary
          echo "## Rendered Resources (${OVERLAY})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Kind |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          for f in "${OUTPUT_DIR}"/*.yaml; do
            fname=$(basename "$f")
            kind=$(yq eval '.kind' "$f")
            echo "| ${fname} | ${kind} |" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Validate policies
        id: validate
        run: |
          OUTPUT_DIR="${{ steps.render.outputs.output_dir }}"

          echo "## Policy Validation (${{ matrix.overlay }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if ./scripts/validate-policies.sh "${OUTPUT_DIR}" 2>&1 | tee validation-output.txt; then
            echo "All policy checks passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "Policy violations found:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat validation-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Authenticate to ConfigHub
        if: github.event_name != 'pull_request' || github.event_name == 'pull_request'
        run: cub auth login --as-worker
        env:
          CONFIGHUB_WORKER_ID: ${{ secrets.CONFIGHUB_WORKER_ID }}
          CONFIGHUB_WORKER_SECRET: ${{ secrets.CONFIGHUB_WORKER_SECRET }}

      - name: Export current ConfigHub state
        id: export
        run: |
          SPACE="${{ steps.render.outputs.space }}"
          OUTPUT_DIR="${{ steps.render.outputs.output_dir }}"
          mkdir -p confighub-current

          echo "Exporting current state from ConfigHub space: $SPACE"

          UNITS=$(cub unit list --space "$SPACE" --format json 2>/dev/null | jq -r '.[].name' 2>/dev/null || echo "")

          if [[ -z "$UNITS" ]]; then
            echo "No existing units in ConfigHub (first deployment)"
            echo "first_deployment=true" >> $GITHUB_OUTPUT
          else
            echo "first_deployment=false" >> $GITHUB_OUTPUT
            for unit in $UNITS; do
              echo "  Exporting: $unit"
              cub unit export --space "$SPACE" "$unit" > "confighub-current/${unit}.yaml" 2>/dev/null || true
            done
          fi

      - name: Detect conflicts (ADR-011)
        id: conflict
        if: steps.export.outputs.first_deployment != 'true'
        run: |
          SPACE="${{ steps.render.outputs.space }}"
          OUTPUT_DIR="${{ steps.render.outputs.output_dir }}"

          echo "## Conflict Detection (${{ matrix.overlay }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          HAS_CONFLICT=false

          for ch_file in confighub-current/*.yaml; do
            [[ -f "$ch_file" ]] || continue
            unit=$(basename "$ch_file" .yaml)

            # Check if this unit maps to a rendered resource
            git_file="${OUTPUT_DIR}/${unit}.yaml"

            if [[ ! -f "$git_file" ]]; then
              echo "**CONFLICT**: Unit \`$unit\` exists in ConfigHub but not in rendered output" >> $GITHUB_STEP_SUMMARY
              HAS_CONFLICT=true
              continue
            fi

            CH_CONTENT=$(yq eval -P "$ch_file" 2>/dev/null || cat "$ch_file")
            GIT_CONTENT=$(yq eval -P "$git_file" 2>/dev/null || cat "$git_file")

            if [[ "$CH_CONTENT" != "$GIT_CONTENT" ]]; then
              LAST_CHANGE=$(cub unit get --space "$SPACE" "$unit" --format json 2>/dev/null | jq -r '.lastChangeDesc // ""' || echo "")

              if [[ "$LAST_CHANGE" != CI:* ]]; then
                echo "**CONFLICT**: Unit \`$unit\` was modified in ConfigHub (not by CI)" >> $GITHUB_STEP_SUMMARY
                HAS_CONFLICT=true
              else
                echo "Unit \`$unit\`: differs but last change was from CI" >> $GITHUB_STEP_SUMMARY
              fi
            else
              echo "Unit \`$unit\`: matches" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "has_conflict=$HAS_CONFLICT" >> $GITHUB_OUTPUT

      - name: Fail on conflict (unless forced)
        if: steps.conflict.outputs.has_conflict == 'true' && github.event.inputs.force != 'true' && github.ref == 'refs/heads/main'
        run: |
          echo "## Publish Blocked: Conflicts Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ConfigHub has changes not in Git. Per ADR-011, CI cannot silently overwrite." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resolution:" >> $GITHUB_STEP_SUMMARY
          echo "1. Import ConfigHub state to Git" >> $GITHUB_STEP_SUMMARY
          echo "2. Roll back ConfigHub to a previous revision" >> $GITHUB_STEP_SUMMARY
          echo "3. Force publish (re-run with force: true)" >> $GITHUB_STEP_SUMMARY
          exit 1

      - name: Preview changes (PR only)
        if: github.event_name == 'pull_request'
        run: |
          SPACE="${{ steps.render.outputs.space }}"
          OUTPUT_DIR="${{ steps.render.outputs.output_dir }}"

          echo "## ConfigHub Preview (${{ matrix.overlay }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for yaml in "${OUTPUT_DIR}"/*.yaml; do
            unit=$(basename "$yaml" .yaml)
            echo "### Unit: $unit" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if output=$(cub unit update --space "$SPACE" "$unit" "$yaml" --dry-run --verbose 2>&1); then
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$output" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            else
              echo "Error previewing: $output" >> $GITHUB_STEP_SUMMARY
            fi
            echo "" >> $GITHUB_STEP_SUMMARY
          done

      - name: Publish to ConfigHub (main only)
        if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request' && (steps.conflict.outputs.has_conflict != 'true' || github.event.inputs.force == 'true')
        run: |
          SPACE="${{ steps.render.outputs.space }}"
          OUTPUT_DIR="${{ steps.render.outputs.output_dir }}"
          COMMIT_SHA="${{ github.sha }}"
          COMMIT_MSG=$(git log -1 --pretty=%B | head -1)

          echo "## ConfigHub Publish (${{ matrix.overlay }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Publishing to space \`$SPACE\` from commit \`${COMMIT_SHA:0:7}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          for yaml in "${OUTPUT_DIR}"/*.yaml; do
            unit=$(basename "$yaml" .yaml)
            echo "Updating unit: $unit"

            CHANGE_DESC="CI: $COMMIT_MSG (${COMMIT_SHA:0:7})"
            if [[ "${{ github.event.inputs.force }}" == "true" ]]; then
              CHANGE_DESC="CI (forced): $COMMIT_MSG (${COMMIT_SHA:0:7})"
            fi

            # Create unit if it doesn't exist
            cub unit create --space "$SPACE" "$unit" --allow-exists 2>/dev/null || true

            if cub unit update --space "$SPACE" "$unit" "$yaml" \
                --change-desc "$CHANGE_DESC" \
                --wait; then
              echo "**$unit**: Updated" >> $GITHUB_STEP_SUMMARY
            else
              echo "**$unit**: FAILED" >> $GITHUB_STEP_SUMMARY
              exit 1
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All units published." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Git commit**: \`${COMMIT_SHA}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
