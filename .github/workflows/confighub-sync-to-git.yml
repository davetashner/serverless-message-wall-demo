name: Sync ConfigHub to Git

# Phase 1 of ADR-011: ConfigHub → Git sync
#
# This workflow exports the current state from ConfigHub and creates a PR
# if it differs from Git. Ensures Git stays informed of all ConfigHub changes.

on:
  # Run on schedule - check for changes every 6 hours
  schedule:
    - cron: '0 */6 * * *'

  # Allow manual trigger
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to sync'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
      dry_run:
        description: 'Dry run (preview only, no PR)'
        required: false
        default: false
        type: boolean

  # Trigger via webhook from ConfigHub (if configured)
  repository_dispatch:
    types: [confighub-change]

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for branch creation

      - name: Install cub CLI
        run: |
          curl -fsSL https://hub.confighub.com/cub/install.sh | bash
          echo "$HOME/.confighub/bin" >> $GITHUB_PATH

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Authenticate to ConfigHub
        run: cub auth login --as-worker
        env:
          CONFIGHUB_WORKER_ID: ${{ secrets.CONFIGHUB_WORKER_ID }}
          CONFIGHUB_WORKER_SECRET: ${{ secrets.CONFIGHUB_WORKER_SECRET }}

      - name: Determine environment
        id: env
        run: |
          # Use input, dispatch payload, or default
          if [[ -n "${{ github.event.inputs.environment }}" ]]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [[ -n "${{ github.event.client_payload.environment }}" ]]; then
            ENV="${{ github.event.client_payload.environment }}"
          else
            ENV="dev"
          fi
          echo "environment=$ENV" >> $GITHUB_OUTPUT

          # Load config
          ENV_FILE="config/${ENV}.env"
          if [[ -f "$ENV_FILE" ]]; then
            source "$ENV_FILE"
            echo "space=$CONFIGHUB_SPACE" >> $GITHUB_OUTPUT
          else
            echo "Error: Config file not found: $ENV_FILE"
            exit 1
          fi

      - name: Export ConfigHub state
        id: export
        run: |
          SPACE="${{ steps.env.outputs.space }}"
          ENV="${{ steps.env.outputs.environment }}"

          echo "Exporting from ConfigHub space: $SPACE"

          mkdir -p confighub-export

          # Get list of units
          UNITS=$(cub unit list --space "$SPACE" --format json 2>/dev/null | jq -r '.[].name' || echo "")

          if [[ -z "$UNITS" ]]; then
            echo "No units found in space $SPACE"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Export each unit
          for unit in $UNITS; do
            echo "  Exporting: $unit"
            cub unit export --space "$SPACE" "$unit" > "confighub-export/${unit}.yaml" 2>/dev/null || {
              echo "  Warning: Failed to export unit $unit"
            }
          done

          # Get ConfigHub revision info for change description
          LATEST_REVISION=$(cub unit list --space "$SPACE" --format json 2>/dev/null | jq -r '.[0].headRevisionNum // "unknown"')
          echo "latest_revision=$LATEST_REVISION" >> $GITHUB_OUTPUT

      - name: Render Git templates
        id: render
        run: |
          ENV="${{ steps.env.outputs.environment }}"
          ENV_FILE="config/${ENV}.env"
          source "$ENV_FILE"

          mkdir -p git-rendered

          for template in infra/base/*.yaml.template; do
            [[ -f "$template" ]] || continue
            outfile="git-rendered/$(basename "${template%.template}")"
            envsubst '${AWS_ACCOUNT_ID} ${AWS_REGION} ${RESOURCE_PREFIX} ${ENVIRONMENT} ${BUCKET_NAME}' < "$template" > "$outfile"
          done

      - name: Compare and detect changes
        id: compare
        run: |
          CHANGES=""
          HAS_CHANGES=false

          for ch_file in confighub-export/*.yaml; do
            [[ -f "$ch_file" ]] || continue
            unit=$(basename "$ch_file")
            git_file="git-rendered/$unit"

            if [[ ! -f "$git_file" ]]; then
              echo "NEW: $unit (in ConfigHub, not in Git)"
              CHANGES+="- NEW: $unit\n"
              HAS_CHANGES=true
              continue
            fi

            if ! diff -q <(yq eval -P "$ch_file" 2>/dev/null || cat "$ch_file") \
                         <(yq eval -P "$git_file" 2>/dev/null || cat "$git_file") >/dev/null 2>&1; then
              echo "CHANGED: $unit"
              CHANGES+="- CHANGED: $unit\n"
              HAS_CHANGES=true
            else
              echo "MATCH: $unit"
            fi
          done

          echo "has_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT
          echo "changes<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create sync PR
        if: steps.compare.outputs.has_changes == 'true' && github.event.inputs.dry_run != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ENV="${{ steps.env.outputs.environment }}"
          SPACE="${{ steps.env.outputs.space }}"
          TIMESTAMP=$(date -u +%Y%m%d-%H%M%S)
          BRANCH="sync/confighub-${ENV}-${TIMESTAMP}"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create branch
          git checkout -b "$BRANCH"

          # Copy ConfigHub exports to sync directory
          mkdir -p "confighub-sync/${ENV}"
          cp confighub-export/*.yaml "confighub-sync/${ENV}/" 2>/dev/null || true

          # Create metadata file
          cat > "confighub-sync/${ENV}/.sync-metadata.json" <<EOF
          {
            "synced_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "confighub_space": "$SPACE",
            "environment": "$ENV",
            "source": "confighub",
            "workflow_run": "${{ github.run_id }}"
          }
          EOF

          # Commit
          git add confighub-sync/
          git commit -m "sync: Import ConfigHub state for ${ENV}

          ConfigHub space: $SPACE
          Latest revision: ${{ steps.export.outputs.latest_revision }}

          Changes:
          ${{ steps.compare.outputs.changes }}

          Per ADR-011: Bidirectional GitOps with ConfigHub as Authority"

          # Push
          git push -u origin "$BRANCH"

          # Create PR
          gh pr create \
            --title "sync: Import ConfigHub state for ${ENV}" \
            --body "## Summary

          This PR syncs configuration changes from ConfigHub back to Git.

          **ConfigHub Space:** \`$SPACE\`
          **Environment:** \`$ENV\`
          **Synced at:** $(date -u +%Y-%m-%dT%H:%M:%SZ)
          **Workflow run:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ## Changes

          ${{ steps.compare.outputs.changes }}

          ## Why This Matters

          Per [ADR-011](docs/decisions/011-ci-confighub-authority-conflict.md), ConfigHub is the authoritative source for configuration. This sync ensures:

          - Git stays informed of all changes (bulk operations, policy adjustments, break-glass)
          - Full history in Git for compliance/audit
          - Developers see what operators changed
          - Next CI run won't have stale data

          ## Review Guidelines

          - Review the changes to understand what was modified in ConfigHub
          - Merge to acknowledge the sync and update Git's view
          - If changes should be reverted, use ConfigHub to roll back first

          ---
          *Generated by confighub-sync-to-git workflow*" \
            --label "sync,confighub,automated"

      - name: Summary
        run: |
          echo "## ConfigHub → Git Sync Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Space:** ${{ steps.env.outputs.space }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.compare.outputs.has_changes }}" == "true" ]]; then
            echo "### Changes Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "${{ steps.compare.outputs.changes }}" >> $GITHUB_STEP_SUMMARY

            if [[ "${{ github.event.inputs.dry_run }}" == "true" ]]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "⚠️ **Dry run mode** - No PR created" >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "✅ PR created to sync changes" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "✅ No changes detected. Git and ConfigHub are in sync." >> $GITHUB_STEP_SUMMARY
          fi
